pokeDataAll = '[{},{"BaseAttack":126,"BaseDefense":126,"BaseStamina":90,"Id":1},{"BaseAttack":156,"BaseDefense":158,"BaseStamina":120,"Id":2},{"BaseAttack":198,"BaseDefense":200,"BaseStamina":160,"Id":3},{"BaseAttack":128,"BaseDefense":108,"BaseStamina":78,"Id":4},{"BaseAttack":160,"BaseDefense":140,"BaseStamina":116,"Id":5},{"BaseAttack":212,"BaseDefense":182,"BaseStamina":156,"Id":6},{"BaseAttack":112,"BaseDefense":142,"BaseStamina":88,"Id":7},{"BaseAttack":144,"BaseDefense":176,"BaseStamina":118,"Id":8},{"BaseAttack":186,"BaseDefense":222,"BaseStamina":158,"Id":9},{"BaseAttack":62,"BaseDefense":66,"BaseStamina":90,"Id":10},{"BaseAttack":56,"BaseDefense":86,"BaseStamina":100,"Id":11},{"BaseAttack":144,"BaseDefense":144,"BaseStamina":120,"Id":12},{"BaseAttack":68,"BaseDefense":64,"BaseStamina":80,"Id":13},{"BaseAttack":62,"BaseDefense":82,"BaseStamina":90,"Id":14},{"BaseAttack":144,"BaseDefense":130,"BaseStamina":130,"Id":15},{"BaseAttack":94,"BaseDefense":90,"BaseStamina":80,"Id":16},{"BaseAttack":126,"BaseDefense":122,"BaseStamina":126,"Id":17},{"BaseAttack":170,"BaseDefense":166,"BaseStamina":166,"Id":18},{"BaseAttack":92,"BaseDefense":86,"BaseStamina":60,"Id":19},{"BaseAttack":146,"BaseDefense":150,"BaseStamina":110,"Id":20},{"BaseAttack":102,"BaseDefense":78,"BaseStamina":80,"Id":21},{"BaseAttack":168,"BaseDefense":146,"BaseStamina":130,"Id":22},{"BaseAttack":112,"BaseDefense":112,"BaseStamina":70,"Id":23},{"BaseAttack":166,"BaseDefense":166,"BaseStamina":120,"Id":24},{"BaseAttack":124,"BaseDefense":108,"BaseStamina":70,"Id":25},{"BaseAttack":200,"BaseDefense":154,"BaseStamina":120,"Id":26},{"BaseAttack":90,"BaseDefense":114,"BaseStamina":100,"Id":27},{"BaseAttack":150,"BaseDefense":172,"BaseStamina":150,"Id":28},{"BaseAttack":100,"BaseDefense":104,"BaseStamina":110,"Id":29},{"BaseAttack":132,"BaseDefense":136,"BaseStamina":140,"Id":30},{"BaseAttack":184,"BaseDefense":190,"BaseStamina":180,"Id":31},{"BaseAttack":110,"BaseDefense":94,"BaseStamina":92,"Id":32},{"BaseAttack":142,"BaseDefense":128,"BaseStamina":122,"Id":33},{"BaseAttack":204,"BaseDefense":170,"BaseStamina":162,"Id":34},{"BaseAttack":116,"BaseDefense":124,"BaseStamina":140,"Id":35},{"BaseAttack":178,"BaseDefense":178,"BaseStamina":190,"Id":36},{"BaseAttack":106,"BaseDefense":118,"BaseStamina":76,"Id":37},{"BaseAttack":176,"BaseDefense":194,"BaseStamina":146,"Id":38},{"BaseAttack":98,"BaseDefense":54,"BaseStamina":230,"Id":39},{"BaseAttack":168,"BaseDefense":108,"BaseStamina":280,"Id":40},{"BaseAttack":88,"BaseDefense":90,"BaseStamina":80,"Id":41},{"BaseAttack":164,"BaseDefense":164,"BaseStamina":150,"Id":42},{"BaseAttack":134,"BaseDefense":130,"BaseStamina":90,"Id":43},{"BaseAttack":162,"BaseDefense":158,"BaseStamina":120,"Id":44},{"BaseAttack":202,"BaseDefense":190,"BaseStamina":150,"Id":45},{"BaseAttack":122,"BaseDefense":120,"BaseStamina":70,"Id":46},{"BaseAttack":162,"BaseDefense":170,"BaseStamina":120,"Id":47},{"BaseAttack":108,"BaseDefense":118,"BaseStamina":120,"Id":48},{"BaseAttack":172,"BaseDefense":154,"BaseStamina":140,"Id":49},{"BaseAttack":108,"BaseDefense":86,"BaseStamina":20,"Id":50},{"BaseAttack":148,"BaseDefense":140,"BaseStamina":70,"Id":51},{"BaseAttack":104,"BaseDefense":94,"BaseStamina":80,"Id":52},{"BaseAttack":156,"BaseDefense":146,"BaseStamina":130,"Id":53},{"BaseAttack":132,"BaseDefense":112,"BaseStamina":100,"Id":54},{"BaseAttack":194,"BaseDefense":176,"BaseStamina":160,"Id":55},{"BaseAttack":122,"BaseDefense":96,"BaseStamina":80,"Id":56},{"BaseAttack":178,"BaseDefense":150,"BaseStamina":130,"Id":57},{"BaseAttack":156,"BaseDefense":110,"BaseStamina":110,"Id":58},{"BaseAttack":230,"BaseDefense":180,"BaseStamina":180,"Id":59},{"BaseAttack":108,"BaseDefense":98,"BaseStamina":80,"Id":60},{"BaseAttack":132,"BaseDefense":132,"BaseStamina":130,"Id":61},{"BaseAttack":180,"BaseDefense":202,"BaseStamina":180,"Id":62},{"BaseAttack":110,"BaseDefense":76,"BaseStamina":50,"Id":63},{"BaseAttack":150,"BaseDefense":112,"BaseStamina":80,"Id":64},{"BaseAttack":186,"BaseDefense":152,"BaseStamina":110,"Id":65},{"BaseAttack":118,"BaseDefense":96,"BaseStamina":140,"Id":66},{"BaseAttack":154,"BaseDefense":144,"BaseStamina":160,"Id":67},{"BaseAttack":198,"BaseDefense":180,"BaseStamina":180,"Id":68},{"BaseAttack":158,"BaseDefense":78,"BaseStamina":100,"Id":69},{"BaseAttack":190,"BaseDefense":110,"BaseStamina":130,"Id":70},{"BaseAttack":222,"BaseDefense":152,"BaseStamina":160,"Id":71},{"BaseAttack":106,"BaseDefense":136,"BaseStamina":80,"Id":72},{"BaseAttack":170,"BaseDefense":196,"BaseStamina":160,"Id":73},{"BaseAttack":106,"BaseDefense":118,"BaseStamina":80,"Id":74},{"BaseAttack":142,"BaseDefense":156,"BaseStamina":110,"Id":75},{"BaseAttack":176,"BaseDefense":198,"BaseStamina":160,"Id":76},{"BaseAttack":168,"BaseDefense":138,"BaseStamina":100,"Id":77},{"BaseAttack":200,"BaseDefense":170,"BaseStamina":130,"Id":78},{"BaseAttack":110,"BaseDefense":110,"BaseStamina":180,"Id":79},{"BaseAttack":184,"BaseDefense":198,"BaseStamina":190,"Id":80},{"BaseAttack":128,"BaseDefense":138,"BaseStamina":50,"Id":81},{"BaseAttack":186,"BaseDefense":180,"BaseStamina":100,"Id":82},{"BaseAttack":138,"BaseDefense":132,"BaseStamina":104,"Id":83},{"BaseAttack":126,"BaseDefense":96,"BaseStamina":70,"Id":84},{"BaseAttack":182,"BaseDefense":150,"BaseStamina":120,"Id":85},{"BaseAttack":104,"BaseDefense":138,"BaseStamina":130,"Id":86},{"BaseAttack":156,"BaseDefense":192,"BaseStamina":180,"Id":87},{"BaseAttack":124,"BaseDefense":110,"BaseStamina":160,"Id":88},{"BaseAttack":180,"BaseDefense":188,"BaseStamina":210,"Id":89},{"BaseAttack":120,"BaseDefense":112,"BaseStamina":60,"Id":90},{"BaseAttack":196,"BaseDefense":196,"BaseStamina":100,"Id":91},{"BaseAttack":136,"BaseDefense":82,"BaseStamina":60,"Id":92},{"BaseAttack":172,"BaseDefense":118,"BaseStamina":90,"Id":93},{"BaseAttack":204,"BaseDefense":156,"BaseStamina":120,"Id":94},{"BaseAttack":90,"BaseDefense":186,"BaseStamina":70,"Id":95},{"BaseAttack":104,"BaseDefense":140,"BaseStamina":120,"Id":96},{"BaseAttack":162,"BaseDefense":196,"BaseStamina":170,"Id":97},{"BaseAttack":116,"BaseDefense":110,"BaseStamina":60,"Id":98},{"BaseAttack":178,"BaseDefense":168,"BaseStamina":110,"Id":99},{"BaseAttack":102,"BaseDefense":124,"BaseStamina":80,"Id":100},{"BaseAttack":150,"BaseDefense":174,"BaseStamina":120,"Id":101},{"BaseAttack":110,"BaseDefense":132,"BaseStamina":120,"Id":102},{"BaseAttack":232,"BaseDefense":164,"BaseStamina":190,"Id":103},{"BaseAttack":102,"BaseDefense":150,"BaseStamina":100,"Id":104},{"BaseAttack":140,"BaseDefense":202,"BaseStamina":120,"Id":105},{"BaseAttack":148,"BaseDefense":172,"BaseStamina":100,"Id":106},{"BaseAttack":138,"BaseDefense":204,"BaseStamina":100,"Id":107},{"BaseAttack":126,"BaseDefense":160,"BaseStamina":180,"Id":108},{"BaseAttack":136,"BaseDefense":142,"BaseStamina":80,"Id":109},{"BaseAttack":190,"BaseDefense":198,"BaseStamina":130,"Id":110},{"BaseAttack":110,"BaseDefense":116,"BaseStamina":160,"Id":111},{"BaseAttack":166,"BaseDefense":160,"BaseStamina":210,"Id":112},{"BaseAttack":40,"BaseDefense":60,"BaseStamina":500,"Id":113},{"BaseAttack":164,"BaseDefense":152,"BaseStamina":130,"Id":114},{"BaseAttack":142,"BaseDefense":178,"BaseStamina":210,"Id":115},{"BaseAttack":122,"BaseDefense":100,"BaseStamina":60,"Id":116},{"BaseAttack":176,"BaseDefense":150,"BaseStamina":110,"Id":117},{"BaseAttack":112,"BaseDefense":126,"BaseStamina":90,"Id":118},{"BaseAttack":172,"BaseDefense":160,"BaseStamina":160,"Id":119},{"BaseAttack":130,"BaseDefense":128,"BaseStamina":60,"Id":120},{"BaseAttack":194,"BaseDefense":192,"BaseStamina":120,"Id":121},{"BaseAttack":154,"BaseDefense":196,"BaseStamina":80,"Id":122},{"BaseAttack":176,"BaseDefense":180,"BaseStamina":140,"Id":123},{"BaseAttack":172,"BaseDefense":134,"BaseStamina":130,"Id":124},{"BaseAttack":198,"BaseDefense":160,"BaseStamina":130,"Id":125},{"BaseAttack":214,"BaseDefense":158,"BaseStamina":130,"Id":126},{"BaseAttack":184,"BaseDefense":186,"BaseStamina":130,"Id":127},{"BaseAttack":148,"BaseDefense":184,"BaseStamina":150,"Id":128},{"BaseAttack":42,"BaseDefense":84,"BaseStamina":40,"Id":129},{"BaseAttack":192,"BaseDefense":196,"BaseStamina":190,"Id":130},{"BaseAttack":186,"BaseDefense":190,"BaseStamina":260,"Id":131},{"BaseAttack":110,"BaseDefense":110,"BaseStamina":96,"Id":132},{"BaseAttack":114,"BaseDefense":128,"BaseStamina":110,"Id":133},{"BaseAttack":186,"BaseDefense":168,"BaseStamina":260,"Id":134},{"BaseAttack":192,"BaseDefense":174,"BaseStamina":130,"Id":135},{"BaseAttack":238,"BaseDefense":178,"BaseStamina":130,"Id":136},{"BaseAttack":156,"BaseDefense":158,"BaseStamina":130,"Id":137},{"BaseAttack":132,"BaseDefense":160,"BaseStamina":70,"Id":138},{"BaseAttack":180,"BaseDefense":202,"BaseStamina":140,"Id":139},{"BaseAttack":148,"BaseDefense":142,"BaseStamina":60,"Id":140},{"BaseAttack":190,"BaseDefense":190,"BaseStamina":120,"Id":141},{"BaseAttack":182,"BaseDefense":162,"BaseStamina":160,"Id":142},{"BaseAttack":180,"BaseDefense":180,"BaseStamina":320,"Id":143},{"BaseAttack":198,"BaseDefense":242,"BaseStamina":180,"Id":144},{"BaseAttack":232,"BaseDefense":194,"BaseStamina":180,"Id":145},{"BaseAttack":242,"BaseDefense":194,"BaseStamina":180,"Id":146},{"BaseAttack":128,"BaseDefense":110,"BaseStamina":82,"Id":147},{"BaseAttack":170,"BaseDefense":152,"BaseStamina":122,"Id":148},{"BaseAttack":250,"BaseDefense":212,"BaseStamina":182,"Id":149},{"BaseAttack":284,"BaseDefense":202,"BaseStamina":212,"Id":150},{"BaseAttack":220,"BaseDefense":220,"BaseStamina":200,"Id":151}]'
tcpms = [
  0.094
  0.1351374
  0.1663979
  0.1926509
  0.2157325
  0.2365727
  0.2557201
  0.2735304
  0.2902499
  0.3060574
  0.3210876
  0.335445
  0.3492127
  0.3624578
  0.3752356
  0.3875924
  0.3995673
  0.4111936
  0.4225
  0.4335117
  0.4431076
  0.45306
  0.4627984
  0.4723361
  0.481685
  0.4908558
  0.4998584
  0.5087018
  0.517394
  0.5259425
  0.5343543
  0.5426358
  0.5507927
  0.5588306
  0.5667545
  0.5745692
  0.5822789
  0.5898879
  0.5974
  0.6048188
  0.6121573
  0.6194041
  0.6265671
  0.6336492
  0.640653
  0.647581
  0.6544356
  0.6612193
  0.667934
  0.6745819
  0.6811649
  0.6876849
  0.6941437
  0.7005429
  0.7068842
  0.7131691
  0.7193991
  0.7255756
  0.7317
  0.734741
  0.7377695
  0.7407856
  0.7437894
  0.7467812
  0.749761
  0.7527291
  0.7556855
  0.7586304
  0.7615638
  0.7644861
  0.7673972
  0.7702973
  0.7731865
  0.776065
  0.7789328
  0.7817901
  0.784637
  0.7874736
  0.7903
  0.7931164
]
pokeDataJson = JSON.parse(pokeDataAll)
pokeCardContainer = undefined
mutationObserver = undefined
observerConfig = undefined
usingMutations = true

aMutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver

if !aMutationObserver
  usingMutations = false

if usingMutations #if not, probably IE10 or below
  mutationObserver = new MutationObserver((mut) ->
    startCalc()
    return
  )
  observerConfig = 
    attributes: true
    childList: true
    characterData: true

startCalc = ->
  pokemonNodes = document.getElementsByClassName('pokemon-card')
  iii = 0
  while iii < pokemonNodes.length
    currCard = pokemonNodes[iii]
    currPokeData = currCard.getElementsByClassName('hidden')[0].innerHTML.split('&nbsp;')
    currLevel = '??'
    try
      currID = parseInt(currPokeData[0])
      currCP = parseInt(currPokeData[1])
      currATK = parseInt(currPokeData[2])
      currDEF = parseInt(currPokeData[3])
      currSTA = parseInt(currPokeData[4])
      currLevel = getLevel(currID, currCP, currATK, currDEF, currSTA)
    catch err
      console.err 'error calculating level for node: ' + iii
    finally
      currCard.getElementsByClassName('level')[0].innerHTML = 'Lv ' + currLevel
    iii++
  return

getLevel = (id, cp, atk, def, sta) ->
  currPokemon = pokeDataJson[id]
  baseAtk = currPokemon['BaseAttack']
  baseDef = currPokemon['BaseDefense']
  baseSta = currPokemon['BaseStamina']
  rhs = (baseAtk + atk) * Math.sqrt(baseDef + def) * Math.sqrt(baseSta + sta) * 0.1
  currCpM = Math.sqrt((cp + 0.5) / rhs)
  #actual formula has floor(), doing the intermediate one
  nearestCpM = tcpms.reduce((last, curr) ->
    if Math.abs(curr - currCpM) < Math.abs(last - currCpM) then curr else last
  )
  index = tcpms.indexOf(nearestCpM)
  (index + 2) / 2.0

$(document).on 'turbolinks:load', (event) ->
  startCalc()
  pokeCardContainer = document.getElementsByClassName('show-pokemon-container')[0]
  if usingMutations
    mutationObserver.observe pokeCardContainer, observerConfig
  else
    pokeCardContainer.addEventListener "DOMSubtreeModified", (ev)->
      startCalc();
      return
  return
